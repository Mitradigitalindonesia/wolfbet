<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>AutobotX</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial;
      max-width: 600px;
      margin: 30px auto;
      padding: 20px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    h2 { text-align: center; }
    .section { margin-bottom: 20px; }
    label, input, select, button {
      width: 100%; margin-top: 10px; padding: 8px; box-sizing: border-box;
    }
    #log {
      background: #f0f0f0; padding: 10px; border-radius: 5px;
      height: 150px; overflow-y: scroll; font-size: 14px; font-family: monospace;
    }
    #balance-bar {
      display: flex; justify-content: space-between; padding: 10px 0; font-weight: bold;
    }
  </style>
</head>
<body>
  <h2>WolfBet AutobotX</h2>
<div style="text-align: right; margin-bottom: 10px;">
  <button id="login-btn" style="
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #28a745;
    color: white;
    border: none;
    font-size: 16px;
    cursor: pointer;
  ">ðŸ”‘</button>
</div>

<div class="section">
  <label>Token (Bearer)</label>
  <input type="text" id="manual-token" placeholder="Masukkan token API..." />
</div>
  <div class="section" id="balance-bar">
    <div>Balance: <span id="balance">-</span></div>
    <div>PNL: <span id="PNL">0</span></div>
  </div>

  <div class="section">
    <label>Token</label>
    <select id="token-select"></select>

    <label>Bet Awal</label>
    <input type="number" id="base-bet" value="1" min="0.00000001" step="any" />

    <label>Interval (detik)</label>
    <input type="number" id="interval" value="3" min="1" />
  </div>

  <div class="section">
    <canvas id="result-chart" height="100"></canvas>
  </div>

  <div class="section">
    <button id="start-btn">Start</button>
    <button id="stop-btn" disabled>Stop</button>
    <button id="take-profit-btn">Take Profit</button>
  </div>

  <div class="section">
    <h4>Riwayat Taruhan</h4>
    <div id="log"></div>
  </div>

  <script>
  document.getElementById('login-btn').onclick = () => {
  const inputToken = document.getElementById('manual-token').value.trim();
  if (!inputToken) return alert('Token tidak boleh kosong');
  localStorage.setItem('token', inputToken);
  alert('Token disimpan. Siap digunakan.');
};
    const tokenSelect = document.getElementById('token-select');
    const balanceEl = document.getElementById('balance');
    const pklEl = document.getElementById('pkl');
    const baseBetInput = document.getElementById('base-bet');
    const intervalInput = document.getElementById('interval');
    const logEl = document.getElementById('log');
    const startBtn = document.getElementById('start-btn');
    const stopBtn = document.getElementById('stop-btn');
    const takeProfitBtn = document.getElementById('take-profit-btn');

    let botInterval = null;
    let currentBet = 0;
    let profit = 0;
    let round = 0;
    let baseBet = 0;
    let chart;
    let chartData = [];

    // Dummy: ambil semua token dari localStorage
    const savedToken = localStorage.getItem('token');
    if (savedToken) {
      const option = document.createElement('option');
      option.value = savedToken;
      option.textContent = savedToken.slice(0, 10) + '...';
      tokenSelect.appendChild(option);
    }
    const token = localStorage.getItem('token');

    const log = msg => {
      const time = new Date().toLocaleTimeString();
      logEl.innerHTML += `[${time}] ${msg}<br>`;
      logEl.scrollTop = logEl.scrollHeight;
    };

    const updateChart = (val) => {
      chartData.push(val);
      if (chartData.length > 50) chartData.shift();
      chart.data.labels = chartData.map((_, i) => i + 1);
      chart.data.datasets[0].data = chartData;
      chart.update();
    };

    const fetchBalance = async (token) => {
      try {
        const res = await fetch('https://wolfbet.com/api/v1/user/balances', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();
        const balanceObj = data.data.find(b => b.currency === 'btc');
        return balanceObj ? balanceObj.amount : 0;
      } catch {
        return 0;
      }
    };

    const placeBet = async (token) => {
      const chance = Math.floor(Math.random() * (55 - 25 + 1)) + 25;
      const rule = Math.random() > 0.5 ? 'over' : 'under';
      const betValue = rule === 'over' ? 100 - chance : chance;
      const multiplier = 99 / chance;

      try {
        const res = await fetch('https://wolfbet.com/api/v1/bet', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            currency: 'btc',
            game: 'dice',
            amount: currentBet,
            rule,
            multiplier,
            bet_value: betValue
          })
        });

        const result = await res.json();
        const payout = result.bet.payout || 0;
        const profitChange = payout - currentBet;
        profit += profitChange;
        round += 1;

        // Update UI
        log(`${rule} ${chance}% â†’ ${payout ? 'Win' : 'Loss'} | Profit: ${profit.toFixed(8)}`);
        updateChart(profit);
        balanceEl.textContent = result.user_balance.btc;
        pklEl.textContent = profit.toFixed(8);

        // Cek apakah reset ke base bet
        if (profit >= baseBet * 3) {
          currentBet = baseBet;
          profit = 0;
          log('Take Profit 3x tercapai, reset ke base bet');
        } else {
          currentBet += baseBet * 0.01;
        }

      } catch (err) {
        log('Error bet: ' + err.message);
      }
    };

    startBtn.onclick = async () => {
      const token = tokenSelect.value;
      baseBet = parseFloat(baseBetInput.value);
      currentBet = baseBet;

      if (!token || !baseBet) {
        alert('Token dan Bet awal wajib diisi');
        return;
      }

      const balance = await fetchBalance(token);
      balanceEl.textContent = balance;

      startBtn.disabled = true;
      stopBtn.disabled = false;

      botInterval = setInterval(() => {
        placeBet(token);
      }, parseInt(intervalInput.value) * 1000);
    };

    stopBtn.onclick = () => {
      clearInterval(botInterval);
      botInterval = null;
      startBtn.disabled = false;
      stopBtn.disabled = true;
      log('Bot dihentikan');
    };

    takeProfitBtn.onclick = () => {
      profit = 0;
      currentBet = baseBet;
      log('Manual Take Profit: reset ke base bet');
    };

    // Inisialisasi Chart
    chart = new Chart(document.getElementById('result-chart'), {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'Profit',
          data: [],
          borderColor: 'green',
          tension: 0.3
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  </script>
</body>
</html>

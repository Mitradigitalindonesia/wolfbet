<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AutobotX - WolfBet SHIB</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: 20px auto; padding: 10px; }
    #login-section, #bot-ui { margin-bottom: 20px; }
    #balance-pnl { display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 10px; }
    #history { max-height: 150px; overflow-y: auto; background: #f0f0f0; padding: 10px; border-radius: 5px; }
    button { padding: 10px; margin-right: 10px; }
    input { padding: 8px; width: 100%; box-sizing: border-box; margin-bottom: 10px; }
    #login-btn { border-radius: 50%; width: 50px; height: 50px; font-weight: bold; cursor: pointer; }
  </style>
</head>
<body>

  <div id="login-section">
    <button id="login-btn" title="Login">L</button>
    <h2>AutobotX - Login Token</h2>
    <input id="token-input" placeholder="Masukkan token di sini" />
    <div id="login-error" style="color:red;"></div>
  </div>

  <div id="bot-ui" style="display:none;">
    <div id="balance-pnl">
      <div>Balance SHIB: <span id="balance">0</span></div>
      <div>PNL: <span id="pnl">0</span></div>
    </div>
    <canvas id="betChart" width="600" height="200"></canvas>
    <div style="margin-top:10px;">
      <button id="start-btn">Start</button>
      <button id="stop-btn" disabled>Stop</button>
      <button id="takeprofit-btn">Take Profit</button>
    </div>
    <h3>Riwayat Transaksi</h3>
    <div id="history"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const loginBtn = document.getElementById('login-btn');
    const tokenInput = document.getElementById('token-input');
    const loginError = document.getElementById('login-error');
    const botUI = document.getElementById('bot-ui');
    const balanceSpan = document.getElementById('balance');
    const pnlSpan = document.getElementById('pnl');
    const startBtn = document.getElementById('start-btn');
    const stopBtn = document.getElementById('stop-btn');
    const takeProfitBtn = document.getElementById('takeprofit-btn');
    const historyDiv = document.getElementById('history');
    const ctx = document.getElementById('betChart').getContext('2d');

    let token = '';
    let balance = 0;
    let initialBet = 10;
    let currentBet = initialBet;
    let totalProfit = 0;
    let isRunning = false;
    let betsHistory = [];
    let chart = null;

    function toFixed8(num) {
      return Math.floor(num * 1e8) / 1e8;
    }

    function randomChance() {
      return Math.floor(Math.random() * (55 - 25 + 1)) + 25;
    }

    async function fetchBalance() {
      try {
        const res = await fetch('/api/get-balances', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token })
        });
        const data = await res.json();
        if (data.success && data.balances) {
          const shibBalanceObj = Object.values(data.balances).find(b => b.currency.toLowerCase() === 'shib');
          if (shibBalanceObj) {
            balance = parseFloat(shibBalanceObj.amount);
            balanceSpan.textContent = balance.toFixed(4);
            return balance;
          }
        }
        throw new Error('Gagal mengambil balance SHIB');
      } catch (e) {
        loginError.textContent = e.message;
        return 0;
      }
    }

    async function placeBet(amount, rule, betValue) {
  try {
    const payload = {
      token,
      currency: 'shib',
      game: 'dice',
      amount: toFixed8(amount),
      rule,
      bet_value: betValue
    };

    console.log("Sending bet with data:", payload);

    const res = await fetch('/api/place-bet', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (!res.ok) {
      const text = await res.text();
      throw new Error(`Status ${res.status}: ${text}`);
    }

    const data = await res.json();
    return data;
  } catch (e) {
    console.error(`[ERROR] placeBet(): ${e.message}`);
    throw e;
  }
}

    function setupChart() {
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: betsHistory.map((_, i) => i + 1),
          datasets: [{
            label: 'Profit per Bet (SHIB)',
            data: betsHistory.map(b => b.profit),
            borderColor: 'green',
            backgroundColor: 'rgba(0,128,0,0.1)',
            fill: true,
            tension: 0.3
          }]
        },
        options: {
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    async function startBot() {
      isRunning = true;
      startBtn.disabled = true;
      stopBtn.disabled = false;
      loginError.textContent = '';
      totalProfit = 0;
      currentBet = initialBet;

      while (isRunning) {
        try {
          const chance = randomChance();
          const rule = 'under';
          const betValue = chance;

          if (currentBet > balance) {
            loginError.textContent = 'Saldo tidak cukup untuk taruhan berikutnya, bot berhenti.';
            stopBot();
            break;
          }

          const betResult = await placeBet(currentBet, rule, betValue);
          balance = parseFloat(betResult.user_balance.amount);
          balanceSpan.textContent = balance.toFixed(4);

          const profit = parseFloat(betResult.profit || 0);
          totalProfit += profit;
          pnlSpan.textContent = totalProfit.toFixed(4);

          betsHistory.push({ profit, amount: currentBet, result: betResult.state });
          updateHistory();
          setupChart();

          currentBet = currentBet * 1.01;

          if (totalProfit >= initialBet * 3) {
            currentBet = initialBet;
            totalProfit = 0;
          }

          await new Promise(r => setTimeout(r, 1500));
        } catch (e) {
          loginError.textContent = 'Error saat bet: ' + e.message;
          stopBot();
          break;
        }
      }
    }

    function stopBot() {
      isRunning = false;
      startBtn.disabled = false;
      stopBtn.disabled = true;
    }

    function updateHistory() {
      historyDiv.innerHTML = '';
      for (let i = betsHistory.length - 1; i >= 0; i--) {
        const b = betsHistory[i];
        const color = b.profit > 0 ? 'green' : 'red';
        historyDiv.innerHTML += `<div style="color:${color}">Bet ${b.amount.toFixed(4)} - ${b.result.toUpperCase()} - Profit: ${b.profit.toFixed(4)}</div>`;
      }
    }

    loginBtn.onclick = async () => {
      loginError.textContent = '';
      token = tokenInput.value.trim();
      if (!token) {
        loginError.textContent = 'Token tidak boleh kosong.';
        return;
      }
      try {
        const bal = await fetchBalance();
        if (bal > 0) {
          initialBet = bal * 0.01;
          currentBet = initialBet;
          pnlSpan.textContent = '0';
          betsHistory = [];
          updateHistory();
          setupChart();
          botUI.style.display = 'block';
          alert('Login berhasil, saldo SHIB: ' + bal.toFixed(4));
        } else {
          loginError.textContent = 'Gagal mendapatkan saldo SHIB.';
        }
      } catch (e) {
        loginError.textContent = 'Error saat login: ' + e.message;
      }
    };

    startBtn.onclick = () => {
      if (!isRunning) startBot();
    };

    stopBtn.onclick = () => {
      if (isRunning) stopBot();
    };

    takeProfitBtn.onclick = () => {
      if (isRunning) {
        alert('Bot dihentikan dan profit diambil.');
        stopBot();
        pnlSpan.textContent = '0';
        betsHistory = [];
        updateHistory();
        setupChart();
      }
    };
  </script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WolfBet Dice Bot Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background: #f4f7fa;
      color: #333;
      max-width: 900px;
      margin: 20px auto;
      padding: 20px;
    }

    h2 {
      text-align: center;
      color: #2c3e50;
    }

    #user-info, #balance-info {
      margin-bottom: 10px;
      font-weight: bold;
    }

    .settings {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 20px;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }

    .settings label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }

    .settings div {
      flex: 1;
      min-width: 200px;
    }

    input {
      width: 100%;
      padding: 10px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    button {
      padding: 12px 25px;
      font-size: 16px;
      background-color: #2980b9;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: 0.3s;
      margin-top: 10px;
    }

    button:hover {
      background-color: #1c5980;
    }

    #chart-container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    #log {
      height: 250px;
      overflow-y: auto;
      background: #fff;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      font-family: monospace;
      font-size: 14px;
    }

    .profit { color: green; }
    .lose { color: red; }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      font-size: 12px;
      border-radius: 4px;
      color: white;
      margin-left: 10px;
    }

    .badge.profit { background: green; }
    .badge.lose { background: red; }
  </style>
</head>
<body>

  <h2>WolfBet Dice Bot Dashboard</h2>

  <div id="user-info">User: Loading...</div>
  <div id="balance-info">Saldo: Loading...</div>

  <div class="settings">
    <div>
      <label for="base-bet-percent">Bet Awal (% Saldo)</label>
      <input type="number" id="base-bet-percent" min="0.1" max="100" step="0.1" value="1" />
    </div>

    <div>
      <label for="tp">Take Profit (SHIB)</label>
      <input type="number" id="tp" min="0" step="0.1" value="10" />
    </div>

    <div>
      <label for="sl">Stop Loss (SHIB)</label>
      <input type="number" id="sl" min="0" step="0.1" value="5" />
    </div>

    <div style="align-self: end;">
      <button id="start-stop-btn">Start</button>
    </div>
  </div>

  <div id="chart-container">
    <canvas id="profitChart"></canvas>
  </div>

  <div>
    <h3>Log Hasil Taruhan</h3>
    <div id="log"></div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const token = localStorage.getItem('token');
  const username = localStorage.getItem('username');
  const userid = localStorage.getItem('userid');

  const userInfoDiv = document.getElementById('user-info');
  const balanceInfoDiv = document.getElementById('balance-info');
  const startStopBtn = document.getElementById('start-stop-btn');
  const logDiv = document.getElementById('log');
  const baseBetPercentInput = document.getElementById('base-bet-percent');
  const tpInput = document.getElementById('tp');
  const slInput = document.getElementById('sl');

  if (!token) {
    alert('Token tidak ditemukan, silakan login ulang.');
    window.location.href = 'index.html';
  }

  userInfoDiv.textContent = `User: ${username} (ID: ${userid})`;

  let balances = {};
  let balanceSHIB = 0;

  async function fetchBalances() {
    try {
      const res = await fetch('/api/get-balances', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ token })
      });
      const data = await res.json();
      if (data.success && data.balances) {
        balances = data.balances.reduce((acc, cur) => {
          acc[cur.currency.toUpperCase()] = cur.amount;
          return acc;
        }, {});
        balanceSHIB = balances.SHIB || 0;
        balanceInfoDiv.textContent = `Saldo SHIB: ${balanceSHIB.toFixed(4)}`;
      } else {
        balanceInfoDiv.textContent = `Gagal ambil saldo: ${data.error || 'Unknown error'}`;
      }
    } catch (e) {
      balanceInfoDiv.textContent = 'Kesalahan jaringan saat mengambil saldo.';
    }
  }

  fetchBalances();

  // Bot state
  let botRunning = false;
  let baseBet = 0;
  let currentBet = 0;
  let multiplier = 2;
  let rule = 'under';
  let betValue = 49;
  let profit = 0;
  let sessionProfit = 0;
  let sessionStartedAt = null;

  // Chart setup
  const ctx = document.getElementById('profitChart').getContext('2d');
  const profitChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [{
        label: 'Profit',
        data: [],
        borderColor: 'green',
        backgroundColor: 'rgba(0,128,0,0.2)',
        fill: true,
        tension: 0.3
      }]
    },
    options: {
      animation: false,
      scales: {
        x: { title: { display: true, text: 'Bet Number' } },
        y: { title: { display: true, text: 'Profit (SHIB)' } }
      }
    }
  });

  function log(message, isProfit = null) {
    const time = new Date().toLocaleTimeString();
    const p = document.createElement('p');
    p.textContent = `[${time}] ${message}`;
    if (isProfit !== null) {
      p.className = isProfit ? 'profit' : 'lose';
    }
    logDiv.appendChild(p);
    logDiv.scrollTop = logDiv.scrollHeight;
  }

  async function placeBet() {
    if (!botRunning) return;

    try {
      const res = await fetch('/api/place-bet', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          token,
          amount: currentBet,
          rule,
          multiplier,
          betValue,
          currency: 'SHIB'
        })
      });
      const data = await res.json();

      if (!res.ok) {
        log(`Error taruhan: ${data.error || JSON.stringify(data)}`);
        stopBot();
        return;
      }

      const betProfit = data.profit || 0;
      profit += betProfit;
      sessionProfit += betProfit;

      log(`Bet ke-${profitChart.data.labels.length + 1}: ${betProfit >= 0 ? 'Profit' : 'Lose'} ${betProfit.toFixed(4)} SHIB, Total profit: ${profit.toFixed(4)} SHIB`, betProfit >= 0);

      // Update chart
      profitChart.data.labels.push(profitChart.data.labels.length + 1);
      profitChart.data.datasets[0].data.push(profit);
      profitChart.update();

      await fetchBalances();

      // Check TP & SL
      const tpValue = parseFloat(tpInput.value) || Infinity;
      const slValue = parseFloat(slInput.value) || Infinity;

      if (profit >= tpValue) {
        log(`Take Profit tercapai (${profit.toFixed(4)} SHIB). Bot berhenti.`);
        stopBot();
        return;
      }
      if (profit <= -slValue) {
        log(`Stop Loss tercapai (${profit.toFixed(4)} SHIB). Bot berhenti.`);
        stopBot();
        return;
      }

      // Update bet untuk next round
      if (sessionProfit > 0) {
        currentBet = baseBet;
        sessionProfit = 0;
        sessionStartedAt = Date.now();
      } else {
        currentBet = +(currentBet * 1.01).toFixed(6); // naik 1%
      }

      // Delay antara bet berikutnya (3 detik)
      setTimeout(placeBet, 3000);

    } catch (e) {
      log(`Kesalahan jaringan saat place bet: ${e.message}`);
      stopBot();
    }
  }

  function startBot() {
    if (botRunning) return;

    // Hitung bet awal berdasar persentase saldo
    const percent = parseFloat(baseBetPercentInput.value);
    if (!percent || percent <= 0) {
      alert('Masukkan persentase bet awal yang valid.');
      return;
    }
    if (balanceSHIB <= 0) {
      alert('Saldo SHIB tidak mencukupi.');
      return;
    }
    baseBet = +(balanceSHIB * (percent / 100)).toFixed(6);
    if (baseBet < 0.000001) {
      alert('Bet terlalu kecil.');
      return;
    }

    currentBet = baseBet;
    sessionProfit = 0;
    profit = 0;
    sessionStartedAt = Date.now();

    botRunning = true;
    startStopBtn.textContent = 'Stop';
    log('Bot dimulai.');
    placeBet();
  }

  function stopBot() {
    botRunning = false;
    startStopBtn.textContent = 'Start';
    log('Botfunction stopBot() {
  botRunning = false;
  startStopBtn.textContent = 'Start';
  log('Bot dihentikan.');
}
startStopBtn.onclick = () => {
  if (botRunning) {
    stopBot();
  } else {
    startBot();
  }
};
</script>
</body>
</html>
